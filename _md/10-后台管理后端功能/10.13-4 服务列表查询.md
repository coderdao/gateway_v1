# 10.13-4 服务列表查询.md
> 整个第十章关键在于，是否能够构成 curl 数据链路

看你不顺眼但我不出声，是我在想怎么弄死你

## 定义 input/output 数据结构
dto/service.go
```go
// 定义 输入结构 规则
type ServiceListInput struct {
	Info string `json:"info" form:"info" comment:"关键字" example:"" validate:""`
	PageNo int `json:"page_no" form:"page_no" comment:"页数" example:"1" validate:"required，is_vaild_username"`
}
```
参数说明：
- json：设入参数 json 字段
- form：来源参数字段
- comment：说明
- example：默认数据，可用于 swagger
- validate: 校验方法，默认 required。而 is_vaild_username 是在中间件 middleware/translation.go 自定义验证参数方法
```go
//自定义验证方法
//https://github.com/go-playground/validator/blob/v9/_examples/custom-validation/main.go
val.RegisterValidation("is_vaild_username", func(fl validator.FieldLevel) bool {
    return fl.Field().String() == "admin"
})
```

### 把请求 根据规则 转化为参数
需要 public/params.go 文件方法支持
```go
func (param *ServiceListInput) BindValidParam(c *gin.Context) error {
	return public.DefaultGetValidParams(c, param)
}
```

## 控制器逻辑表写
controller/service.go

### api 文档、测试用例编写
```text
// [方法名称] godoc
// @Summary [方法中文简介]
// @Description [方法中文说明]
// @Tags [所属分组：服务管理]
// @ID [唯一标识-请求路径：/service/service_list]
// @Accept  [接受数据类型：json]
// @Produce  [返回数据类型：json]
// @Param info query string false "关键字"
// @Param [参数名] [获取位置：query] [数据类型：int] [是否必传：true] [参数说明："页数"]
// @Success [成功返回状态：200] {object} middleware.Response{data=dto.ServiceListItemOutput} "success"
// @Router [请求路径：/service/service_list] [请求方法：get]
```

### 方法表写
```go
func (service *ServiceController) ServiceList(ctx *gin.Context) {
	// 校验参数
	params := &dto.ServiceListInput{}
	if err := params.BindValidParam(ctx); err != nil {
		middleware.ResponseError(ctx, 2000, err)
		return
	}

	// 获取数据库链接
	tx, err := lib.GetGormPool("default")
	if err != nil {
		middleware.ResponseError(ctx, 2001, err)
		return
	}

	// 数据库链接查询数据
	serviceInfo := &dao.ServiceInfo{}
	list, total, err := serviceInfo.PageList(ctx, tx, params)
	if err != nil {
		middleware.ResponseError(ctx, 2001, err)
		return
	}

	// 格式化查询数据输出
	outList := []dto.ServiceListItemOutput{}
	for _,listItem:=range  list {
		outItem:=dto.ServiceListItemOutput{
			Id: listItem.Id,
			ServiceName: listItem.ServiceName,
			ServiceDesc: listItem.ServiceDesc,
		}

		outList = append(outList, outItem)
	}

	out := &dto.ServiceListOutput{
		Total:total,
		List:outList,
	}

	fmt.Println(out)
	middleware.ResponseSuccess(ctx, out)
}
```

## 数据操作层编写
dao/service_info.go


 